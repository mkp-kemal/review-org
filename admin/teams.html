<div>
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-users mr-2"></i> Teams Management</h2>
            <button id="toggleAddTeamForm" class="btn btn-light btn-sm" style="display: none;">
                <i class="fas fa-plus"></i> Add Team
            </button>
        </div>

        <!-- Add Team Form (Collapsible) -->
        <div id="addTeamForm" class="p-4 border-bottom" style="display: none; background-color: #f8f9fa;">
            <h5 class="mb-3"><i class="fas fa-plus-circle mr-2"></i> Add New Team</h5>

            <div class="row g-3">
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">Organization</label>
                    <select id="teamOrgSelect" class="form-control form-select">
                        <option value="">Select Organization</option>
                    </select>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">Claim Email</label>
                    <input type="email" id="teamEmail" class="form-control" placeholder="Email for claim">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">Team Name</label>
                    <input type="text" id="teamName" class="form-control" placeholder="Name" required>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">Age Level</label>
                    <input type="text" id="teamAgeLevel" class="form-control" placeholder="Age Level" required>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">Division</label>
                    <input type="text" id="teamDivision" class="form-control" placeholder="Division" required>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">City</label>
                    <input type="text" id="teamCity" class="form-control" placeholder="City" required>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label">State</label>
                    <input type="text" id="teamState" class="form-control" placeholder="State" required>
                </div>
                <div class="col-md-6 col-lg-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="createTeam()">
                        <i class="fas fa-plus"></i> Add Team
                    </button>
                </div>
            </div>

            <!-- CSV Upload Section -->
            <div class="mt-4 pt-3 border-top">
                <h5 class="mb-3"><i class="fas fa-file-csv mr-2"></i> Bulk Upload via CSV</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6 col-lg-4">
                        <label class="form-label">Organization</label>
                        <select id="teamCsvOrgSelect" class="form-control form-select">
                            <option value="">Select Organization</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-6">
                        <label class="form-label">CSV File</label>
                        <div class="input-group">
                            <input type="text" id="teamCsvFileName" class="form-control" placeholder="No file chosen"
                                readonly>
                            <input type="file" id="teamCsvFile" accept=".csv" class="d-none">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="document.getElementById('teamCsvFile').click()">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <button class="btn btn-success w-100" onclick="uploadTeamCsv()">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <!-- Search and Filter Controls -->
            <div class="row mb-3 g-2 align-items-center">
                <div class="col-md-6 col-lg-8">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" id="teamGlobalSearch" class="form-control"
                            placeholder="Search teams by name, organization, city, etc.">
                    </div>
                </div>
                <div class="col-md-6 col-lg-4 d-flex justify-content-md-end">
                    <div class="btn-group">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="teamStatusDropdown"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-filter"></i> Status Filter
                        </button>
                        <div class="dropdown-menu dropdown-menu-right p-3" aria-labelledby="teamStatusDropdown"
                            style="min-width: 200px;">
                            <h6 class="dropdown-header">Filter by Status</h6>
                            <div class="form-check">
                                <input class="form-check-input team-status-filter" type="checkbox" value="APPROVED"
                                    id="filterTeamApproved" checked>
                                <label class="form-check-label" for="filterTeamApproved">
                                    <span class="badge badge-approved">APPROVED</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input team-status-filter" type="checkbox" value="PENDING"
                                    id="filterTeamPending" checked>
                                <label class="form-check-label" for="filterTeamPending">
                                    <span class="badge badge-pending">PENDING</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input team-status-filter" type="checkbox" value="REJECTED"
                                    id="filterTeamRejected" checked>
                                <label class="form-check-label" for="filterTeamRejected">
                                    <span class="badge badge-rejected">REJECTED</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teams Table -->
            <div class="table-responsive">
                <table id="teamTable" class="table table-hover table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col" style="width: 80px;">Logo</th>

                            <th scope="col">Organization</th>
                            <th scope="col">Team Name</th>
                            <th scope="col">Age Level</th>
                            <th scope="col">Division</th>
                            <th scope="col">Location</th>
                            <th scope="col">Plan</th>
                            <th scope="col">Status</th>
                            <th scope="col">Claimed By</th>
                            <th scope="col" style="display: none;" id="isHide">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="teamPaginationInfo">Loading teams...</div>
                <nav aria-label="Teams pagination">
                    <ul class="pagination mb-0" id="teamPaginationControls">
                        <!-- Pagination controls will be inserted here by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <!-- Logo Upload Modal -->
    <div class="modal fade" id="logoUploadModal" tabindex="-1" aria-labelledby="logoUploadModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="logoUploadModalLabel">Upload Team Logo</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentTeamId">
                    <div class="form-group">
                        <label for="logoFileInput">Select Logo Image</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="logoFileInput" accept="image/*">
                            <label class="custom-file-label" for="logoFileInput">Choose file...</label>
                        </div>
                        <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF. Max size: 2MB.</small>
                    </div>
                    <div class="mt-3" id="logoPreviewContainer" style="display: none;">
                        <p class="mt-2 mb-1"><strong>Preview:</strong></p>
                        <img id="logoPreview" src="#" alt="Logo Preview"
                            style="max-height: 150px; max-width: 100%; object-fit: contain;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadLogo()">Upload Logo</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Detail Modal -->
<div class="modal fade" id="teamDetailModal" tabindex="-1" aria-labelledby="teamDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="teamDetailModalLabel">Team Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="teamDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    if (window.user && (window.user.role === 'SITE_ADMIN' || window.user.role === 'ORG_ADMIN')) {
        document.getElementById('isHide').style.display = 'table-cell';
        document.getElementById('addTeamForm').style.display = 'block';
        document.getElementById('toggleAddTeamForm').style.display = 'inline-block';


        document.getElementById('toggleAddTeamForm').addEventListener('click', function () {
            const form = document.getElementById('addTeamForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        });
    }


    document.getElementById('teamCsvFile').addEventListener('change', function (e) {
        const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
        document.getElementById('teamCsvFileName').textContent = fileName;
    });

    function enableEditableCells(selector, type, orgs = []) {
        const cells = document.querySelectorAll(selector);
        cells.forEach(cell => {
            if (cell.dataset.editableAttached) return;
            cell.dataset.editableAttached = 'true';

            cell.addEventListener('dblclick', () => {
                if (cell.querySelector('input') || cell.querySelector('select')) return;

                const currentValue = cell.textContent.trim();
                const id = cell.dataset.id;
                const field = cell.dataset.field;
                let editableElement;

                if (field === 'status') {
                    editableElement = document.createElement('select');
                    editableElement.className = 'form-control';
                    ['PENDING', 'APPROVED', 'REJECTED'].forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        if (val === currentValue) option.selected = true;
                        editableElement.appendChild(option);
                    });
                } else if (field === 'organizationId') {
                    editableElement = document.createElement('select');
                    editableElement.className = 'form-control';
                    orgs.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        if (org.name === currentValue) option.selected = true;
                        editableElement.appendChild(option);
                    });
                } else {
                    editableElement = document.createElement('input');
                    editableElement.className = 'form-control';
                    editableElement.value = currentValue === '-' ? '' : currentValue;
                }

                cell.innerHTML = '';
                cell.appendChild(editableElement);
                editableElement.focus();
                cell.style.backgroundColor = '#e3f2fd';

                const saveChange = async () => {
                    let newValue = (field === 'status' || field === 'organizationId') ? editableElement.value : editableElement.value.trim();

                    if (newValue === currentValue || (currentValue === '-' && !newValue)) {
                        renderCell(currentValue);
                        return;
                    }

                    let bodyData = { [field]: newValue };

                    if (field === 'status' && newValue === 'REJECTED') {
                        const { value: reason, isConfirmed } = await Swal.fire({
                            title: 'Rejected Reason',
                            input: 'text',
                            inputPlaceholder: 'Enter reason...',
                            showCancelButton: true,
                            confirmButtonText: 'Save',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) return 'Please enter a reason!';
                            }
                        });

                        if (!isConfirmed) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to save changes (reason required)',
                            });
                            renderCell(currentValue);
                            return;
                        }

                        bodyData.rejectedReason = reason;
                    }

                    if (newValue || field === 'status' || field === 'organizationId') {
                        const url = `${window.APP_CONFIG.API_URL}/teams/${id}`;
                        try {
                            await fetch(url, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    Authorization: `Bearer ${getCookie('accessToken')}`
                                },
                                body: JSON.stringify(bodyData)
                            });
                        } catch (err) {
                            console.error('Failed to save:', err);
                            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save changes' });
                            renderCell(currentValue);
                            return;
                        }
                    }

                    renderCell(newValue);
                    if (type === 'organization') fetchTeams();
                };

                const renderCell = (newValue) => {
                    if (!newValue) return;

                    if (field === 'organizationId') {
                        const selectedOrg = orgs.find(o => o.id === newValue);
                        cell.textContent = selectedOrg ? selectedOrg.name : currentValue;
                    } else if (field === 'status') {
                        let statusBadge;
                        if (newValue === 'APPROVED') {
                            statusBadge = `<span class="badge badge-approved">${newValue}</span>`;
                        } else if (newValue === 'PENDING') {
                            statusBadge = `<span class="badge badge-pending">${newValue}</span>`;
                        } else {
                            statusBadge = `<span class="badge badge-rejected">${newValue}</span>`;
                        }
                        cell.innerHTML = statusBadge;
                    } else {
                        cell.textContent = newValue || '-';
                    }
                    cell.style.backgroundColor = '';
                };

                editableElement.addEventListener('blur', saveChange);
                editableElement.addEventListener('keydown', e => {
                    if (e.key === 'Enter') editableElement.blur();
                    if (e.key === 'Escape') {
                        if (field === 'status') {
                            cell.innerHTML = currentValue;
                        } else {
                            cell.textContent = currentValue;
                        }
                        cell.style.backgroundColor = '';
                    }
                });
            });
        });
    }

    async function fetchTeams() {
        try {
            let url;
            if (window?.user?.role === 'SITE_ADMIN') {
                url = `${window.APP_CONFIG.API_URL}/teams`;
            } else {
                url = `${window.APP_CONFIG.API_URL}/teams/access/claim`;
            }
            const res = await fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getCookie('accessToken')}` }
            });
            window.allTeams = await res.json();

            renderTable();
            renderPaginationControls();
        } catch (err) {
            console.error("Error fetching teams:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load teams'
            });
        }
    }

    async function fetchOrganizations() {
        try {
            let url;
            if (window?.user?.role === 'SITE_ADMIN') {
                url = `${window.APP_CONFIG.API_URL}/orgs?isFilterByStatus=APPROVED`;
            } else {
                url = `${window.APP_CONFIG.API_URL}/orgs/access/claim`;
            }

            const res = await fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getCookie('accessToken')}` }
            });
            window.teamsList = await res.json();

            const orgSelect = document.getElementById('teamOrgSelect');
            const orgCsvSelect = document.getElementById('teamCsvOrgSelect');

            orgSelect.innerHTML = '<option value="">Select Organization</option>';
            orgCsvSelect.innerHTML = '<option value="">Select Organization</option>';

            window.teamsList.forEach(org => {
                orgSelect.innerHTML += `<option value="${org.id}">${org.name}</option>`;
                orgCsvSelect.innerHTML += `<option value="${org.id}">${org.name}</option>`;
            });
        } catch (err) {
            console.error("Error fetching organizations:", err);
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#teamTable tbody');
        tbody.innerHTML = '';

        const checkedStatuses = Array.from(document.querySelectorAll('.team-status-filter:checked')).map(cb => cb.value);
        let filteredTeams = window.allTeams;

        if (checkedStatuses.length > 0) {
            filteredTeams = window.allTeams.filter(team => checkedStatuses.includes(team.status));
        }

        const searchTerm = document.getElementById('teamGlobalSearch').value.toLowerCase();
        if (searchTerm) {
            filteredTeams = filteredTeams.filter(team =>
                (team.organization?.name && team.organization.name.toLowerCase().includes(searchTerm)) ||
                (team.name && team.name.toLowerCase().includes(searchTerm)) ||
                (team.ageLevel && team.ageLevel.toLowerCase().includes(searchTerm)) ||
                (team.division && team.division.toLowerCase().includes(searchTerm)) ||
                (team.city && team.city.toLowerCase().includes(searchTerm)) ||
                (team.state && team.state.toLowerCase().includes(searchTerm)) ||
                (team.status && team.status.toLowerCase().includes(searchTerm)) ||
                (team.rejectedReason && team.rejectedReason.toLowerCase().includes(searchTerm))
            );
        }

        const startIndex = (window.currentPageTeam - 1) * window.itemsPerPageTeam;
        const endIndex = Math.min(startIndex + window.itemsPerPageTeam, filteredTeams.length);
        const paginatedTeams = filteredTeams.slice(startIndex, endIndex);

        document.getElementById('teamPaginationInfo').textContent =
            `Showing ${startIndex + 1} to ${endIndex} of ${filteredTeams.length} teams`;

        paginatedTeams.forEach(team => {
            const tr = document.createElement('tr');

            let statusBadge;
            if (team.status === 'APPROVED') {
                statusBadge = `<span class="badge badge-approved">${team.status}</span>`;
            } else if (team.status === 'PENDING') {
                statusBadge = `<span class="badge badge-pending">${team.status}</span>`;
            } else {
                statusBadge = `<span class="badge badge-rejected">${team.status}</span>`;
            }


            const location = `${team.city || '-'}${team.city && team.state ? ', ' : ''}${team.state || ''}`;


            let planBadge = team?.subscription?.plan || '-';
            if (team?.subscription?.plan) {
                const planClass = team.subscription.plan === 'ELITE' ? 'badge-success' :
                    team.subscription.plan === 'PRO' ? 'badge-info' : 'badge-secondary';
                planBadge = `<span class="badge ${planClass}">${team.subscription.plan}</span>`;
            }

            tr.innerHTML = `
                <td class="text-center align-middle" style="cursor: pointer;" onclick="openLogoUploadModal('${team.id}')">
                    ${team.logo ?
                                `<img src="${team.logo}" alt="Team Logo" style="max-height: 50px; max-width: 50px; object-fit: contain; border: 1px solid #dee2e6; border-radius: 4px;">` :
                                `<span class="text-muted" style="font-size: 0.85rem;">No Logo<br><i class="fas fa-upload"></i></span>`
                            }
                </td>
                <td class="editable" data-field="organizationId" data-id="${team.id}">${team.organization?.name || '-'}</td>
                <td class="editable" data-field="name" data-id="${team.id}">${team.name || '-'}</td>
                <td class="editable" data-field="ageLevel" data-id="${team.id}">${team.ageLevel || '-'}</td>
                <td class="editable" data-field="division" data-id="${team.id}">${team.division || '-'}</td>
                <td>${location}</td>
                <td>${planBadge}</td>
                ${window.user.role === 'SITE_ADMIN' ?
                    `<td class="editable" data-field="status" data-id="${team.id}">${statusBadge}</td>` :
                    `<td>${statusBadge}</td>`}
                <td>${team.claimedBy?.email || '-'}</td>
                ${window.user.role === 'SITE_ADMIN' ?
                    `<td class="text-nowrap">
                        <button class="btn btn-info btn-sm mr-1" onclick="viewTeamDetails('${team.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-danger btn-sm mr-1" onclick="deleteTeam('${team.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ${team.claimedBy ?
                        `<button class="btn btn-success btn-sm" data-toggle="tooltip" data-placement="top" title="${team?.claimedBy?.email}">
                                <i class="fas fa-check"></i> Claimed
                            </button>` :
                        `<button class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="top" title="Claim team" onclick="claimTeam('${team.id}')">
                                <i class="fas fa-bookmark"></i> Claim
                            </button>`}
                    </td>` :
                    `<td class="text-nowrap">
                        <button class="btn btn-info btn-sm" onclick="viewTeamDetails('${team.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>`}
            `;
            tbody.appendChild(tr);
        });

        enableEditableCells('.editable', 'team', window.teamsList);


        if (typeof $ !== 'undefined' && $.fn.tooltip) {
            $('[data-toggle="tooltip"]').tooltip();
        }
    }

    function viewTeamDetails(teamId) {
        const team = window.allTeams.find(t => t.id === teamId);
        if (!team) return;

        let statusBadge;
        if (team.status === 'APPROVED') {
            statusBadge = `<span class="badge badge-approved">${team.status}</span>`;
        } else if (team.status === 'PENDING') {
            statusBadge = `<span class="badge badge-pending">${team.status}</span>`;
        } else {
            statusBadge = `<span class="badge badge-rejected">${team.status}</span>`;
        }

        let planBadge = team?.subscription?.plan || '-';
        if (team?.subscription?.plan) {
            const planClass = team.subscription.plan === 'ELITE' ? 'badge-success' :
                team.subscription.plan === 'PRO' ? 'badge-info' : 'badge-secondary';
            planBadge = `<span class="badge ${planClass}">${team.subscription.plan}</span>`;
        }

        const detailHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h5>Team Information</h5>
                    <table class="table table-sm">
                        <tr>
                            <th>Team Name:</th>
                            <td>${team.name || '-'}</td>
                        </tr>
                        <tr>
                            <th>Organization:</th>
                            <td>${team.organization?.name || '-'}</td>
                        </tr>
                        <tr>
                            <th>Age Level:</th>
                            <td>${team.ageLevel || '-'}</td>
                        </tr>
                        <tr>
                            <th>Division:</th>
                            <td>${team.division || '-'}</td>
                        </tr>
                        <tr>
                            <th>Location:</th>
                            <td>${team.city || '-'}${team.city && team.state ? ', ' : ''}${team.state || ''}</td>
                        </tr>
                        <tr>
                            <th>Plan:</th>
                            <td>${planBadge}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>${statusBadge}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h5>Organization Details</h5>
                    <table class="table table-sm">
                        <tr>
                            <th>Organization Name:</th>
                            <td>${team.organization?.name || '-'}</td>
                        </tr>
                        <tr>
                            <th>City:</th>
                            <td>${team.organization?.city || '-'}</td>
                        </tr>
                        <tr>
                            <th>State:</th>
                            <td>${team.organization?.state || '-'}</td>
                        </tr>
                        <tr>
                            <th>Website:</th>
                            <td>
                                ${team.organization?.website ?
                `<a href="${team.organization.website.trim()}" target="_blank" class="text-primary">
                                        ${team.organization.website.trim()}
                                    </a>` : '-'}
                            </td>
                        </tr>
                    </table>
                    
                    <h5 class="mt-4">Team Management</h5>
                    <table class="table table-sm">
                        <tr>
                            <th>Claimed By:</th>
                            <td>${team.claimedBy?.email || 'Not claimed'}</td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td>${new Date(team.createdAt).toLocaleString()}</td>
                        </tr>
                        <tr>
                            <th>Last Updated:</th>
                            <td>${new Date(team.updatedAt).toLocaleString()}</td>
                        </tr>
                        ${team.status === 'REJECTED' && team.rejectedReason ?
                `<tr>
                                <th>Rejection Reason:</th>
                                <td class="text-danger">${team.rejectedReason}</td>
                            </tr>` : ''}
                    </table>
                </div>
            </div>
        `;

        document.getElementById('teamDetailContent').innerHTML = detailHtml;
        $('#teamDetailModal').modal('show');
    }

    function renderPaginationControls() {
        const checkedStatuses = Array.from(document.querySelectorAll('.team-status-filter:checked')).map(cb => cb.value);
        let filteredTeams = window.allTeams;

        if (checkedStatuses.length > 0) {
            filteredTeams = window.allTeams.filter(team => checkedStatuses.includes(team.status));
        }

        const searchTerm = document.getElementById('teamGlobalSearch').value.toLowerCase();
        if (searchTerm) {
            filteredTeams = filteredTeams.filter(team =>
                (team.organization?.name && team.organization.name.toLowerCase().includes(searchTerm)) ||
                (team.name && team.name.toLowerCase().includes(searchTerm)) ||
                (team.ageLevel && team.ageLevel.toLowerCase().includes(searchTerm)) ||
                (team.division && team.division.toLowerCase().includes(searchTerm)) ||
                (team.city && team.city.toLowerCase().includes(searchTerm)) ||
                (team.state && team.state.toLowerCase().includes(searchTerm)) ||
                (team.status && team.status.toLowerCase().includes(searchTerm)) ||
                (team.rejectedReason && team.rejectedReason.toLowerCase().includes(searchTerm))
            );
        }

        const totalPages = Math.ceil(filteredTeams.length / window.itemsPerPageTeam);
        const paginationControls = document.getElementById('teamPaginationControls');
        paginationControls.innerHTML = '';

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${window.currentPageTeam === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${window.currentPageTeam - 1})" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
        paginationControls.appendChild(prevLi);

        const maxVisiblePages = 5;
        let startPage = Math.max(1, window.currentPageTeam - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
            paginationControls.appendChild(firstLi);

            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationControls.appendChild(ellipsisLi);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === window.currentPageTeam ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            paginationControls.appendChild(pageLi);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationControls.appendChild(ellipsisLi);
            }

            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
            paginationControls.appendChild(lastLi);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${window.currentPageTeam === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${window.currentPageTeam + 1})" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
        paginationControls.appendChild(nextLi);
    }

    function changePage(page) {
        if (page < 1 || page > Math.ceil(window.allTeams.length / window.itemsPerPageTeam)) return;
        window.currentPageTeam = page;
        renderTable();
        renderPaginationControls();
    }


    document.getElementById('teamGlobalSearch').addEventListener('input', function () {
        window.currentPageTeam = 1;
        renderTable();
        renderPaginationControls();
    });

    document.querySelectorAll('.team-status-filter').forEach(cb => {
        cb.addEventListener('change', function () {
            window.currentPageTeam = 1;
            renderTable();
            renderPaginationControls();
        });
    });

    async function createTeam() {
        const organizationId = document.getElementById('teamOrgSelect').value;
        const email = document.getElementById('teamEmail').value;
        const name = document.getElementById('teamName').value;
        const ageLevel = document.getElementById('teamAgeLevel').value;
        const division = document.getElementById('teamDivision').value;
        const city = document.getElementById('teamCity').value;
        const state = document.getElementById('teamState').value;

        if (!organizationId) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Please select an organization' });
            return;
        }

        if (!name) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Team name is required' });
            return;
        }

        try {
            const response = await fetch(`${window.APP_CONFIG.API_URL}/teams`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getCookie('accessToken')}` },
                body: JSON.stringify({ organizationId, email, name, ageLevel, division, city, state })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create team');
            }


            document.getElementById('teamEmail').value = '';
            document.getElementById('teamName').value = '';
            document.getElementById('teamAgeLevel').value = '';
            document.getElementById('teamDivision').value = '';
            document.getElementById('teamCity').value = '';
            document.getElementById('teamState').value = '';

            Swal.fire({ icon: 'success', title: 'Success', text: 'Team created successfully' });
            fetchTeams();
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: error.message });
        }
    }

    async function deleteTeam(id) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${getCookie('accessToken')}` }
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Delete failed');
            }

            Swal.fire({ icon: 'success', title: 'Deleted!', text: 'Team has been deleted.' });
            fetchTeams();
        } catch (err) {
            Swal.fire({ icon: 'error', title: 'Error', text: err.message });
        }
    }

    async function claimTeam(teamId) {
        const team = window.allTeams.find(t => t.id === teamId);

        if (!team) {
            Swal.fire('Error', 'Team not found', 'error');
            return;
        }

        const { value: email } = await Swal.fire({
            title: `Claim Team: ${team.name}`,
            input: 'email',
            inputLabel: 'Enter your email to claim this team',
            inputPlaceholder: 'your@email.com',
            inputAttributes: {
                autocapitalize: 'off',
                autocomplete: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Submit',
            cancelButtonText: 'Cancel',
            showLoaderOnConfirm: true,
            preConfirm: (email) => {
                if (!email) {
                    Swal.showValidationMessage('Email is required');
                    return false;
                }
                return email;
            }
        });

        if (email) {
            try {
                const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/claim/${teamId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('accessToken')}`,
                    },
                    body: JSON.stringify({ email })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed with status ${res.status}`);
                }

                const data = await res.json();

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: `Team "${team.name}" has been claimed with email: ${email}`
                });

                team.claimedBy = { email };
                renderTable();
            } catch (err) {
                Swal.fire('Error', err.message || 'Failed to claim team', 'error');
            }
        }
    }

    async function uploadTeamCsv() {
        const fileInput = document.getElementById('teamCsvFile');
        const orgId = document.getElementById('teamCsvOrgSelect').value;

        if (!fileInput.files.length) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Please select a CSV file' });
            return;
        }

        if (!orgId) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Please select an organization' });
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('organizationId', orgId);

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/upload-csv`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${getCookie('accessToken')}` },
                body: formData
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Upload failed');
            }

            const data = await res.json();
            Swal.fire({
                icon: 'success',
                title: 'Upload Complete',
                html: `
                    <p><i class="fas fa-check-circle" style="color: #4cc9f0;"></i> Created: ${data.data.created.length}</p>
                    <p><i class="fas fa-exclamation-circle" style="color: #f8961e;"></i> Skipped: ${data.data.skipped.length > 0 ? data.data.skipped.join(', ') : 'None'}</p>
                `
            });

            fileInput.value = '';
            document.getElementById('teamCsvFileName').textContent = 'No file chosen';
            fetchTeams();
        } catch (err) {
            console.error('Upload failed:', err);
            Swal.fire({ icon: 'error', title: 'Upload Failed', text: err.message });
        }
    }


    function openLogoUploadModal(teamId) {
        document.getElementById('currentTeamId').value = teamId;
        document.getElementById('logoFileInput').value = '';
        document.getElementById('logoPreviewContainer').style.display = 'none';
        document.querySelector('#logoFileInput + .custom-file-label').textContent = 'Choose file...';


        if (typeof $('#logoUploadModal').modal === 'function') {
            $('#logoUploadModal').modal('show');
        } else {
            document.getElementById('logoUploadModal').style.display = 'block';
        }
    }


    document.getElementById('logoFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        const label = e.target.nextElementSibling;
        label.textContent = file ? file.name : 'Choose file...';

        const previewContainer = document.getElementById('logoPreviewContainer');
        const previewImg = document.getElementById('logoPreview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
        }
    });


    async function uploadLogo() {
        const teamId = document.getElementById('currentTeamId').value;
        const fileInput = document.getElementById('logoFileInput');
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Please select an image file.' });
            return;
        }

        if (!teamId) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Team ID not found.' });
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('teamId', teamId);

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/upload-logo`, {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${getCookie('accessToken')}`
                },
                body: formData
            });

            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || 'Upload failed');
            }

            const data = await res.json();
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Team logo uploaded successfully!'
            });


            if (typeof $('#logoUploadModal').modal === 'function') {
                $('#logoUploadModal').modal('hide');
            } else {
                document.getElementById('logoUploadModal').style.display = 'none';
            }


            fetchTeams();
        } catch (err) {
            console.error('Logo upload failed:', err);
            Swal.fire({ icon: 'error', title: 'Upload Failed', text: err.message });
        }
    }


    document.querySelectorAll('.custom-file-input').forEach(input => {
        input.addEventListener('change', function (e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose file...';
            e.target.nextElementSibling.textContent = fileName;
        });
    });


    fetchOrganizations();
    fetchTeams();
</script>

<style>
    .badge-approved {
        background-color: #28a745;
        color: white;
    }

    .badge-pending {
        background-color: #ffc107;
        color: black;
    }

    .badge-rejected {
        background-color: #dc3545;
        color: white;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-info {
        background-color: #17a2b8;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    .table th {
        font-weight: 600;
    }

    .editable {
        cursor: pointer;
    }

    .editable:hover {
        background-color: #f8f9fa;
    }

    .file-input-wrapper {
        position: relative;
        overflow: hidden;
    }

    .file-input-btn {
        background: #28a745;
        color: white;
        padding: 0.375rem 0.75rem;
        border: 1px solid #28a745;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    .file-input-wrapper input[type="file"] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .modal-body h5 {
        margin-bottom: 1rem;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }

    .modal-body .table th {
        width: 40%;
        font-weight: 500;
    }

    #addTeamForm .form-label {
        font-weight: 500;
        margin-bottom: 0.2rem;
    }

    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        .btn-group {
            width: 100%;
        }

        .btn-group .btn {
            width: 100%;
        }
    }
</style>
<div>
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-building"></i> Organizations</h2>
        </div>
        <div class="card-body">
            <div class="form-inline">
                <div class="form-group">
                    <input type="text" id="orgName" class="form-control" placeholder="Name">
                </div>
                <div class="form-group">
                    <input type="text" id="orgCity" class="form-control" placeholder="City">
                </div>
                <div class="form-group">
                    <input type="text" id="orgState" class="form-control" placeholder="State">
                </div>
                <div class="form-group">
                    <input type="text" id="orgWebsite" class="form-control" placeholder="Website">
                </div>
                <!-- <div class="form-group">
                            <select id="orgStatus" class="form-control">
                                <option value="PENDING">PENDING</option>
                                <option value="APPROVED">APPROVED</option>
                                <option value="REJECTED">REJECTED</option>
                            </select>
                        </div> -->
                <button class="btn btn-primary" onclick="createOrganization()">
                    <i class="fas fa-plus"></i> Add Organization
                </button>
            </div>

            <!-- CSV Upload -->
            <div class="form-inline" style="margin-top:20px;">
                <div class="form-group" style="flex-grow: 1;">
                    <div class="file-input-wrapper">
                        <button class="file-input-btn">
                            <i class="fas fa-file-csv"></i> Choose CSV File
                        </button>
                        <input type="file" id="orgCsvFile" accept=".csv">
                        <span id="orgCsvFileName" class="file-name">No file chosen</span>
                    </div>
                </div>
                <button class="btn btn-success" onclick="uploadOrgCsv()">
                    <i class="fas fa-upload"></i> Upload CSV
                </button>
            </div>

            <div class="table-responsive" style="margin-top: 20px;">
                <!-- GLOBAL SEARCH ORGANIZATIONS -->
                <div class="form-inline" style="margin-bottom:10px;">
                    <input type="text" id="orgGlobalSearch" class="form-control" placeholder="ðŸ” Search all columns"
                        style="flex-grow:1;">

                    <!-- STATUS FILTER -->
                    <div class="dropdown" style="margin-left:10px; position:relative;">
                        <button class="btn btn-secondary" onclick="toggleDropdown('orgStatusDropdown')">
                            Filter Status
                        </button>
                        <div id="orgStatusDropdown" class="dropdown-content"
                            style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; z-index:1000;">
                            <label><input type="checkbox" class="org-status-filter" value="APPROVED">
                                APPROVED</label><br>
                            <label><input type="checkbox" class="org-status-filter" value="PENDING">
                                PENDING</label><br>
                            <label><input type="checkbox" class="org-status-filter" value="REJECTED">
                                REJECTED</label>
                        </div>
                    </div>
                </div>

                <table id="orgTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>City</th>
                            <th>State</th>
                            <th>Website</th>
                            <th>Status</th>
                            <th>Reason Reject</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function fetchWithAuth(url, options = {}) {
        let accessToken = getCookie('accessToken');
        let res = await fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${accessToken}`
            }
        });

        // Kalau token expired
        if (res.status === 401) {
            const refreshToken = getCookie('refreshToken');
            if (!refreshToken) {
                // window.location.href = 'Login.html';
                return;
            }

            // Minta token baru
            const refreshRes = await fetch(`${window.APP_CONFIG.API_URL}/auth/refresh`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken })
            });

            if (!refreshRes.ok) {
                // window.location.href = 'Login.html';
                return;
            }

            const data = await refreshRes.json();
            // Simpan ulang cookie
            document.cookie = `accessToken=${data.accessToken}; path=/`;
            document.cookie = `refreshToken=${data.refreshToken}; path=/`;

            // Ulang request dengan token baru
            res = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${data.accessToken}`
                }
            });
        }

        return res;
    }

    async function checkCredentials() {
        try {
            // Panggil API check pakai fetchWithAuth
            const res = await fetchWithAuth(`${window.APP_CONFIG.API_URL}/auth/check`, {
                method: "GET"
            });

            if (!res || !res.ok) {
                window.location.replace('/Login.html');
                return { isAuthenticated: false };
            }

            await fetchOrganizations();

            // document.getElementById("loading").style.display = "none";
            // document.getElementById("adminContent").style.display = "block";
            // document.body.style.display = "block";
            return { isAuthenticated: true };
        } catch (err) {
            console.error("checkCredentials error:", err);
            window.location.replace('/Login.html');
            return { isAuthenticated: false };
        }
    }

    async function fetchOrganizations() {
        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/orgs`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getCookie('accessToken')}` }
            });
            const data = await res.json();
            const tbody = document.querySelector('#orgTable tbody');

            orgsList = data;

            tbody.innerHTML = '';

            data.forEach(org => {
                const tr = document.createElement('tr');

                let statusBadge;
                if (org.status === 'APPROVED') {
                    statusBadge = `<span class="badge badge-approved">${org.status}</span>`;
                } else if (org.status === 'PENDING') {
                    statusBadge = `<span class="badge badge-pending">${org.status}</span>`;
                } else {
                    statusBadge = `<span class="badge badge-rejected">${org.status}</span>`;
                }

                tr.innerHTML = `
                        <td class="editable" data-field="name" data-id="${org.id}">${org.name}</td>
                        <td class="editable" data-field="city" data-id="${org.id}">${org.city}</td>
                        <td class="editable" data-field="state" data-id="${org.id}">${org.state}</td>
                        <td class="editable" data-field="website" data-id="${org.id}">${org.website || '-'}</td>
                        <td class="editable" data-field="status" data-id="${org.id}">${statusBadge}</td>
                        <td>${org.rejectedReason || '-'}</td>
                        <td class="actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteOrganization('${org.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                tbody.appendChild(tr);
            });

            enableEditableCells('.editable', 'organization', orgsList);
        } catch (err) {
            console.error("fetchOrganizations error:", err);
        }
    }

    function enableEditableCells(selector, type, orgs = []) {
        const cells = document.querySelectorAll(selector);
        cells.forEach(cell => {
            if (cell.dataset.editableAttached) return;
            cell.dataset.editableAttached = 'true';

            cell.addEventListener('dblclick', () => {
                if (cell.querySelector('input') || cell.querySelector('select')) return;

                const currentValue = cell.textContent.trim();
                const id = cell.dataset.id;
                const field = cell.dataset.field;
                let editableElement;

                if (field === 'status') {
                    editableElement = document.createElement('select');
                    editableElement.className = 'status-select';
                    ['PENDING', 'APPROVED', 'REJECTED'].forEach(val => {
                        const option = document.createElement('option');
                        option.value = val; option.textContent = val;
                        if (val === currentValue) option.selected = true;
                        editableElement.appendChild(option);
                    });
                } else if (field === 'organizationId') {
                    editableElement = document.createElement('select');
                    editableElement.className = 'form-control';
                    orgs.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id; option.textContent = org.name;
                        if (org.name === currentValue) option.selected = true;
                        editableElement.appendChild(option);
                    });
                } else {
                    editableElement = document.createElement('input');
                    editableElement.className = 'form-control';
                    editableElement.value = currentValue === '-' ? '' : currentValue;
                }

                cell.innerHTML = '';
                cell.appendChild(editableElement);
                editableElement.focus();
                cell.style.backgroundColor = 'var(--primary-light)';

                const saveChange = async () => {
                    let newValue = (field === 'status' || field === 'organizationId') ? editableElement.value : editableElement.value.trim();

                    // Jangan simpan kalau tidak berubah
                    if (newValue === currentValue || (currentValue === '-' && !newValue)) {
                        renderCell(currentValue);
                        return;
                    }

                    let bodyData = { [field]: newValue };

                    // Jika REJECTED, minta alasan
                    if (field === 'status' && newValue === 'REJECTED') {
                        const { value: reason, isConfirmed } = await Swal.fire({
                            title: 'Rejected Reason',
                            input: 'text',
                            inputPlaceholder: 'Enter reason...',
                            showCancelButton: true,
                            confirmButtonText: 'Save',
                            cancelButtonText: 'Cancel',
                            inputValidator: (value) => {
                                if (!value) return 'Please enter a reason!';
                            }
                        });

                        if (!isConfirmed) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to save changes (reason required)',
                            });
                            renderCell(currentValue);
                            return;
                        }

                        bodyData.rejectedReason = reason;
                    }

                    if (newValue || field === 'status' || field === 'organizationId') {
                        const url = `${window.APP_CONFIG.API_URL}/orgs/${id}`;
                        try {
                            await fetch(url, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    Authorization: `Bearer ${getCookie('accessToken')}`
                                },
                                body: JSON.stringify(bodyData)
                            });
                        } catch (err) {
                            console.error('Failed to save:', err);
                            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save changes' });
                            renderCell(currentValue);
                            return;
                        }
                    }

                    renderCell(newValue);
                    if (type === 'organization') fetchOrganizations();
                };


                const renderCell = (newValue) => {
                    if (!newValue) return;

                    if (field === 'organizationId') {
                        const selectedOrg = orgs.find(o => o.id === newValue);
                        cell.textContent = selectedOrg ? selectedOrg.name : currentValue;
                    } else if (field === 'status') {
                        let statusBadge;
                        if (newValue === 'APPROVED') {
                            statusBadge = `<span class="badge badge-approved">${newValue}</span>`;
                        } else if (newValue === 'PENDING') {
                            statusBadge = `<span class="badge badge-pending">${newValue}</span>`;
                        } else {
                            statusBadge = `<span class="badge badge-rejected">${newValue}</span>`;
                        }
                        cell.innerHTML = statusBadge;
                    } else {
                        cell.textContent = newValue || '-';
                    }
                    cell.style.backgroundColor = '';
                };

                editableElement.addEventListener('blur', saveChange);
                editableElement.addEventListener('keydown', e => {
                    if (e.key === 'Enter') editableElement.blur();
                    if (e.key === 'Escape') {
                        if (field === 'status') {
                            cell.innerHTML = currentValue;
                        } else {
                            cell.textContent = currentValue;
                        }
                        cell.style.backgroundColor = '';
                    }
                });
            });
        });
    }

    // ---------------- Create & Delete ----------------
    async function createOrganization() {
        const name = document.getElementById('orgName').value;
        const city = document.getElementById('orgCity').value;
        const state = document.getElementById('orgState').value;
        const website = document.getElementById('orgWebsite').value;
        // const status = document.getElementById('orgStatus').value;

        if (!name) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Organization name is required' });
            return;
        }

        try {
            const response = await fetch(`${window.APP_CONFIG.API_URL}/orgs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getCookie('accessToken')}` },
                body: JSON.stringify({ name, city, state, website })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create organization');
            }

            // Clear form fields
            document.getElementById('orgName').value = '';
            document.getElementById('orgCity').value = '';
            document.getElementById('orgState').value = '';
            document.getElementById('orgWebsite').value = '';

            Swal.fire({ icon: 'success', title: 'Success', text: 'Organization created successfully' });
            fetchOrganizations();
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: error.message });
        }
    }

    async function deleteOrganization(id) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/orgs/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${getCookie('accessToken')}` }
            });

            if (res.status !== 200) {
                const data = await res.json();
                throw new Error(data.message || 'Delete failed');
            }

            Swal.fire({ icon: 'success', title: 'Deleted!', text: 'Organization has been deleted.' });
            fetchOrganizations();
        } catch (err) {
            Swal.fire({ icon: 'error', title: 'Error', text: err.message });
        }
    }

    async function uploadOrgCsv() {
        const fileInput = document.getElementById('orgCsvFile');
        if (!fileInput.files.length) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Please select a CSV file' });
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/orgs/upload-csv`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${getCookie('accessToken')}` },
                body: formData
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Upload failed');
            }

            const data = await res.json();
            Swal.fire({
                icon: 'success',
                title: 'Upload Complete',
                html: `
                            <p><i class="fas fa-check-circle" style="color: #4cc9f0;"></i> Created: ${data.data.created.length}</p>
                            <p><i class="fas fa-exclamation-circle" style="color: #f8961e;"></i> Skipped: ${data.data.skipped.length > 0 ? data.data.skipped.join(', ') : 'None'}</p>
                        `
            });

            // Reset file input
            fileInput.value = '';
            document.getElementById('orgCsvFileName').textContent = 'No file chosen';

            fetchOrganizations();
        } catch (err) {
            console.error('Upload failed:', err);
            Swal.fire({ icon: 'error', title: 'Upload Failed', text: err.message });
        }
    }

    function toggleDropdown(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === "block" ? "none" : "block";
    }

    // General filtering function
    function filterTableGlobalAndStatus(tableId, searchInputId, statusClass, statusIndex) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        const searchValue = document.getElementById(searchInputId).value.toLowerCase();

        // Get checked status filters
        const checkedStatuses = Array.from(document.querySelectorAll(`.${statusClass}:checked`)).map(cb => cb.value);

        rows.forEach(row => {
            let textMatch = false;
            let statusMatch = false;

            // Check global search (any column)
            const cells = row.querySelectorAll("td");
            for (let cell of cells) {
                if (cell.textContent.toLowerCase().includes(searchValue)) {
                    textMatch = true;
                    break;
                }
            }
            if (!searchValue) textMatch = true; // no search = match all

            // Check status filter
            const statusText = row.cells[statusIndex]?.textContent.trim();
            if (checkedStatuses.length === 0 || checkedStatuses.includes(statusText)) {
                statusMatch = true;
            }

            // Show/Hide row
            row.style.display = (textMatch && statusMatch) ? "" : "none";
        });
    }

    // Event listeners ORGS
    document.getElementById("orgGlobalSearch").addEventListener("input", () => {
        filterTableGlobalAndStatus("orgTable", "orgGlobalSearch", "org-status-filter", 4);
    });

    document.querySelectorAll(".org-status-filter").forEach(cb => {
        cb.addEventListener("change", () => {
            filterTableGlobalAndStatus("orgTable", "orgGlobalSearch", "org-status-filter", 4);
        });
    });

    checkCredentials();

</script>
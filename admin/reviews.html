<div>
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-quote-left mr-2"></i> Reviews Management</h2>
            <div class="flex gap-2">
                <!-- Tombol Export CSV -->
                <button class="btn btn-success btn-sm" id="exportCSVBtn"
                    title="Export all reviews as CSV (sorted by current selection)">
                    <i class="fas fa-file-csv mr-2"></i> Export CSV
                </button>
                <!-- Dropdown Sort (tetap ada) -->
                <div class="btn-group">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="reviewSortDropdown"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-sort"></i> Sort By
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="reviewSortDropdown">
                        <a class="dropdown-item" href="#" onclick="fetchReviews('rating')">
                            <i class="fas fa-star mr-2"></i> Rating
                        </a>
                        <a class="dropdown-item" href="#" onclick="fetchReviews('recent')">
                            <i class="fas fa-clock mr-2"></i> Recent
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" id="reviewGlobalSearch" class="form-control"
                        placeholder="Search reviews by team, reviewer, title, or content...">
                </div>
            </div>

            <!-- Reviews Table -->
            <div class="table-responsive">
                <table id="reviewTable" class="table table-hover table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col">Team</th>
                            <th scope="col">Reviewer</th>
                            <th scope="col">Title</th>
                            <th scope="col">Preview</th>
                            <th scope="col">Status</th>
                            <th scope="col">Response</th>
                            <th scope="col">Age/Season</th>
                            <th scope="col">Rating</th>
                            <th scope="col">Flags</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted small" id="paginationInfo">Loading reviews...</div>
                <nav aria-label="Reviews pagination">
                    <ul class="pagination mb-0" id="paginationControls">
                        <!-- Pagination controls will be inserted here by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- REVIEW MODAL -->
<div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-quote-left mr-2"></i>Review Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <!-- Review Header -->
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h4 id="modalTitle" class="mb-1 text-dark font-weight-bold"></h4>
                        <div id="ratingStars" class="mb-2" style="color: #FFC107; font-size: 18px;"></div>
                    </div>
                    <span id="modalDate" class="badge badge-light text-muted"></span>
                </div>

                <!-- Review Content -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <p id="modalBody" class="mb-0 font-italic" style="font-size: 1.1rem; line-height: 1.6;"></p>
                    </div>
                </div>

                <!-- Review Metadata -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-users mr-2 text-primary"></i>Team</h6>
                            <p id="modalTeam" class="mb-0 font-weight-bold"></p>
                            <small id="modalTeamOrg" class="text-muted"></small>
                        </div>
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-user mr-2 text-primary"></i>Reviewer</h6>
                            <p id="modalReviewer" class="mb-0 font-weight-bold"></p>
                        </div>
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-eye mr-2 text-primary"></i>Visibility</h6>
                            <p id="modalPublic" class="mb-0 font-weight-bold"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-calendar-alt mr-2 text-primary"></i>Season</h6>
                            <p id="modalSeason" class="mb-0 font-weight-bold"></p>
                        </div>
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-child mr-2 text-primary"></i>Age Level</h6>
                            <p id="modalAge" class="mb-0 font-weight-bold"></p>
                        </div>
                        <div class="detail-item mb-3">
                            <h6 class="text-muted mb-1"><i class="fas fa-edit mr-2 text-primary"></i>Last Edited</h6>
                            <p id="modalEdited" class="mb-0 font-weight-bold"></p>
                        </div>
                    </div>
                </div>

                <!-- Flags Section -->
                <div id="flagsSection" class="mb-4" style="display: none;">
                    <h5 class="mb-3 text-primary"><i class="fas fa-flag mr-2"></i>Flags</h5>
                    <div id="flagsContainer" class="card border-warning">
                        <div class="card-body py-2">
                            <!-- Flags will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Ratings Section -->
                <h5 class="mb-3 text-primary"><i class="fas fa-star mr-2"></i>Detailed Ratings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Coaching</span>
                                <span id="ratingCoaching" class="font-weight-bold text-primary"></span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progressCoaching" class="progress-bar bg-warning" role="progressbar"></div>
                            </div>
                        </div>
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Development</span>
                                <span id="ratingDevelopment" class="font-weight-bold text-primary"></span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progressDevelopment" class="progress-bar bg-warning" role="progressbar"></div>
                            </div>
                        </div>
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Transparency</span>
                                <span id="ratingTransparency" class="font-weight-bold text-primary"></span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progressTransparency" class="progress-bar bg-warning" role="progressbar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Culture</span>
                                <span id="ratingCulture" class="font-weight-bold text-primary"></span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progressCulture" class="progress-bar bg-warning" role="progressbar"></div>
                            </div>
                        </div>
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Safety</span>
                                <span id="ratingSafety" class="font-weight-bold text-primary"></span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div id="progressSafety" class="progress-bar bg-warning" role="progressbar"></div>
                            </div>
                        </div>
                        <div class="rating-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="font-weight-bold">Overall</span>
                                <span id="ratingOverall" class="font-weight-bold text-primary"
                                    style="font-size: 1.2rem;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Response Section -->
                <div id="adminResponseSection" class="mb-4" style="display: none;">
                    <h5 class="mb-3 text-primary"><i class="fas fa-reply mr-2"></i>Organization Response</h5>
                    <div class="card border-primary">
                        <div class="card-body">
                            <p id="adminResponseText" class="mb-2"></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="adminResponseDate"></small>
                                <small class="text-muted" id="adminResponseBy"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reply Form -->
                <div id="replyForm" class="mt-4">
                    <h5 class="mb-3 text-primary"><i class="fas fa-reply mr-2"></i>Respond to Review</h5>
                    <div class="form-group">
                        <textarea id="replyText" class="form-control" rows="3"
                            placeholder="Write your response here..."></textarea>
                    </div>
                    <div class="d-flex">
                        <button id="submitReplyBtn" class="btn btn-primary mr-2">Submit Response</button>
                        <button id="updateReplyBtn" class="btn btn-success mr-2" style="display: none;">Update
                            Response</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Status Badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
    }

    .status-public {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-private {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Response Badges */
    .response-badge {
        padding: 4px 8px;
        border-radius: 50%;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
    }

    .response-exists {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .response-none {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Flag Badges */
    .flag-badge {
        background-color: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #ffeaa7;
        cursor: pointer;
    }

    .flag-badge:hover {
        background-color: #ffeaa7;
    }

    /* Table styles */
    .table-preview {
        display: block;
        width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .table-preview {
            width: 100px;
        }
    }

    /* Modal styles */
    .modal-body .detail-item h6 {
        margin-bottom: 0.3rem;
    }

    .modal-body .rating-item {
        padding: 0.5rem 0;
    }

    .flag-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .flag-item:hover {
        background-color: #f8f9fa;
    }

    /* Progress bars */
    .progress {
        margin-top: 0.3rem;
        border-radius: 4px;
        background-color: #e9ecef;
    }

    /* Highlighted review row */
    .review-highlighted {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107;
        font-weight: 500;
    }

    .review-highlighted td {
        background-color: #fff3cd !important;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .modal-dialog {
            margin: 0.5rem;
        }

        .modal-content {
            border-radius: 0.3rem;
        }
    }
</style>

<script>

    window.itemsPerPage = window.itemsPerPage || 10;
    window.currentPage = 1;


    window.showReview = showReview;
    window.changePage = changePage;
    window.fetchReviews = fetchReviews;

    async function fetchReviews(sort = "recent", page = 1) {
        window.currentSort = sort;
        try {
            let url;
            if (window?.user?.role === 'SITE_ADMIN') {
                url = `${window.APP_CONFIG.API_URL}/teams/reviews?sort=${sort}`;
            } else {
                url = `${window.APP_CONFIG.API_URL}/teams/reviews/access/claim?sort=${sort}`;
            }

            const res = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${getCookie('accessToken')}`
                }
            });

            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }

            window.allReviews = await res.json();
            window.filteredReviews = [...window.allReviews];
            window.currentPage = page;

            renderTable();
            renderPaginationControls();
        } catch (err) {
            console.error("Error fetching reviews:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load reviews: ' + err.message
            });
        }
    }

    function renderTable() {
        const tbody = document.querySelector("#reviewTable tbody");
        tbody.innerHTML = "";

        const reviews = window.filteredReviews;
        const startIndex = (window.currentPage - 1) * window.itemsPerPage;
        const endIndex = Math.min(startIndex + window.itemsPerPage, reviews.length);
        const paginatedReviews = reviews.slice(startIndex, endIndex);

        document.getElementById('paginationInfo').textContent =
            `Showing ${startIndex + 1} to ${endIndex} of ${reviews.length} reviews`;

        paginatedReviews.forEach(r => {
            const tr = document.createElement("tr");
            const overallRating = r.rating?.overall ?? 0;
            const stars = getStarRating(overallRating);
            const hasResponse = r.orgResponse !== null;
            tr.className = r.isHighlight ? 'review-highlighted' : '';


            const previewText = r.body.length > 50 ? r.body.substring(0, 47) + '...' : r.body;

            tr.innerHTML = `
                <td class="font-weight-bold">${r.team?.name || "-"}</td>
                <td>${r.user?.email || "ANONYMOUS"}</td>
                <td class="font-weight-medium">${r.title}</td>
                <td><span class="table-preview" title="${r.body}">${previewText}</span></td>
                <td class="editable" data-field="isPublic" data-id="${r.id}">
                    <span class="status-badge ${r.isPublic ? 'status-public' : 'status-private'}">
                        ${r.isPublic ? 'Public' : 'Private'}
                    </span>
                </td>
                <td style="text-align: center;">
                    <span class="response-badge ${hasResponse ? 'response-exists' : 'response-none'}" title="${hasResponse ? 'Has response' : 'No response'}">
                        ${hasResponse ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
                    </span>
                </td>
                <td>${r.age_level_at_review}<br><small class="text-muted">${r.season_term} ${r.season_year}</small></td>
                <td style="text-align: center; vertical-align: middle; white-space: nowrap;">
                    <div class="d-flex flex-column align-items-center">
                        <div>${stars}</div>
                        <small class="text-muted">${overallRating.toFixed(1)}/5</small>
                    </div>
                </td>
                <td data-id="${r.id}" style="text-align: center;">
                    ${r.flags && r.flags.length > 0 ?
                    `<span class="flag-badge" title="${r.flags.length} flag(s)">🚩 ${r.flags.length}</span>` :
                    '<span class="text-muted">-</span>'}
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-info" onclick='window.showReview(${JSON.stringify(r).replace(/'/g, "\\'")})'>
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });


        document.querySelector("#reviewTable tbody").addEventListener('click', async function (e) {

            if (
                e.target.closest('button') ||
                e.target.closest('a') ||
                e.target.closest('.status-badge')
            ) {
                return;
            }

            const row = e.target.closest('tr');
            if (!row) return;

            const reviewId = row.querySelector('[data-id]')?.dataset.id;
            if (!reviewId) return;


            const review = window.filteredReviews.find(r => r.id == reviewId);
            if (!review) return;


            const teamPlan = review.team?.subscription?.plan;
            if (teamPlan !== 'ELITE') {
                Swal.fire({
                    icon: 'info',
                    title: 'Feature Unavailable',
                    text: 'Highlight feature is only available for teams with ELITE subscription plan.',
                    confirmButtonText: 'OK'
                });
                return;
            }


            const isCurrentlyHighlighted = review.isHighlight;

            let confirmText, confirmTitle, confirmButton;
            if (isCurrentlyHighlighted) {
                confirmTitle = "Remove Highlight?";
                confirmText = "This review is currently highlighted. Do you want to remove the highlight?";
                confirmButton = 'Remove Highlight';
            } else {
                confirmTitle = "Set as Highlight Review?";
                confirmText = "Do you want to highlight this review on public pages?";
                confirmButton = 'Set Highlight';
            }

            const result = await Swal.fire({
                title: confirmTitle,
                text: confirmText,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: confirmButton,
                cancelButtonText: 'Cancel',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/${reviewId}/reviews/highlight`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${getCookie('accessToken')}`
                    },
                    body: JSON.stringify({
                        isHighlight: !isCurrentlyHighlighted
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${res.status}: Failed to update highlight`);
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: isCurrentlyHighlighted ? 'Highlight removed!' : 'Review is now highlighted!'
                });


                fetchReviews();

            } catch (err) {
                console.error('Error updating highlight:', err);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Failed: ${err.message}`
                });
            }
        });
        enableEditableCells('.editable');
    }

    function enableEditableCells(selector) {
        const cells = document.querySelectorAll(selector);
        cells.forEach(cell => {
            if (cell.dataset.editableAttached) return;
            cell.dataset.editableAttached = 'true';

            cell.addEventListener('dblclick', () => {
                if (cell.querySelector('select')) return;

                const currentValue = cell.textContent.trim();
                const id = cell.dataset.id;
                const field = cell.dataset.field;

                let editableElement = document.createElement('select');
                editableElement.className = 'form-control form-control-sm';

                const options = [
                    { value: 'public', text: 'Public', selected: currentValue === 'Public' },
                    { value: 'private', text: 'Private', selected: currentValue === 'Private' }
                ];

                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    option.selected = opt.selected;
                    editableElement.appendChild(option);
                });

                cell.innerHTML = '';
                cell.appendChild(editableElement);
                editableElement.focus();
                cell.style.backgroundColor = '#e3f2fd';

                const saveChange = async () => {
                    const newValue = editableElement.value === 'public';

                    if ((currentValue === 'Public' && newValue) || (currentValue === 'Private' && !newValue)) {
                        renderCell(newValue);
                        return;
                    }

                    try {
                        const response = await fetch(`${window.APP_CONFIG.API_URL}/teams/${id}/reviews/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${getCookie('accessToken')}`
                            },
                            body: JSON.stringify({ [field]: newValue })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        renderCell(newValue);

                        fetchReviews();
                    } catch (err) {
                        console.error('Failed to save:', err);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to save changes: ' + err.message
                        });
                        renderCell(currentValue === 'Public');
                    }
                };

                const renderCell = (val) => {
                    let statusBadge = val
                        ? `<span class="status-badge status-public">Public</span>`
                        : `<span class="status-badge status-private">Private</span>`;
                    cell.innerHTML = statusBadge;
                    cell.style.backgroundColor = '';
                };

                editableElement.addEventListener('blur', saveChange);
                editableElement.addEventListener('keydown', e => {
                    if (e.key === 'Enter') editableElement.blur();
                    if (e.key === 'Escape') renderCell(currentValue === 'Public');
                });
            });
        });
    }

    function renderPaginationControls() {
        const reviews = window.filteredReviews;
        const totalPages = Math.ceil(reviews.length / window.itemsPerPage);
        const paginationControls = document.getElementById('paginationControls');
        paginationControls.innerHTML = '';


        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${window.currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="window.changePage(${window.currentPage - 1})">&laquo;</a>`;
        paginationControls.appendChild(prevLi);


        const maxVisiblePages = 5;
        let startPage = Math.max(1, window.currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }


        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" onclick="window.changePage(1)">1</a>`;
            paginationControls.appendChild(firstLi);

            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationControls.appendChild(ellipsisLi);
            }
        }


        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === window.currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" onclick="window.changePage(${i})">${i}</a>`;
            paginationControls.appendChild(pageLi);
        }


        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationControls.appendChild(ellipsisLi);
            }

            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" onclick="window.changePage(${totalPages})">${totalPages}</a>`;
            paginationControls.appendChild(lastLi);
        }


        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${window.currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="window.changePage(${window.currentPage + 1})">&raquo;</a>`;
        paginationControls.appendChild(nextLi);
    }

    function changePage(page) {
        const reviews = window.filteredReviews;
        const maxPage = Math.ceil(reviews.length / window.itemsPerPage);

        if (page < 1 || page > maxPage) return;

        window.currentPage = page;
        renderTable();
        renderPaginationControls();
    }

    function getStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

        let stars = '';
        for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star text-warning"></i>';
        if (hasHalfStar) stars += '<i class="fas fa-star-half-alt text-warning"></i>';
        for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star text-warning"></i>';

        return stars;
    }

    function showReview(r) {

        window.currentReviewId = r.id;
        window.currentResponse = r.orgResponse || null;


        document.getElementById('modalTitle').textContent = r.title;
        document.getElementById('modalBody').textContent = r.body;
        document.getElementById('modalTeam').textContent = r.team?.name || "-";


        if (r.team?.organization) {
            document.getElementById('modalTeamOrg').textContent = `Organization: ${r.team.organization.name}`;
        } else {
            document.getElementById('modalTeamOrg').textContent = '';
        }

        document.getElementById('modalReviewer').textContent = r.user?.email || "ANONYMOUS";
        document.getElementById('modalAge').textContent = r.age_level_at_review;
        document.getElementById('modalSeason').textContent = `${r.season_term} ${r.season_year}`;
        document.getElementById('modalDate').textContent = new Date(r.createdAt).toLocaleString();


        const editedDate = new Date(r.editedAt);
        const createdDate = new Date(r.createdAt);
        if (editedDate.getTime() !== createdDate.getTime()) {
            document.getElementById('modalEdited').textContent = new Date(r.editedAt).toLocaleString();
        } else {
            document.getElementById('modalEdited').textContent = 'Never edited';
        }


        const publicBadge = r.isPublic ?
            '<span class="status-badge status-public">Public</span>' :
            '<span class="status-badge status-private">Private</span>';
        document.getElementById('modalPublic').innerHTML = publicBadge;


        const coaching = r.rating?.coaching ?? 0;
        const development = r.rating?.development ?? 0;
        const transparency = r.rating?.transparency ?? 0;
        const culture = r.rating?.culture ?? 0;
        const safety = r.rating?.safety ?? 0;
        const overall = r.rating?.overall ?? 0;

        document.getElementById('ratingCoaching').textContent = coaching.toFixed(1) + '/5';
        document.getElementById('ratingDevelopment').textContent = development.toFixed(1) + '/5';
        document.getElementById('ratingTransparency').textContent = transparency.toFixed(1) + '/5';
        document.getElementById('ratingCulture').textContent = culture.toFixed(1) + '/5';
        document.getElementById('ratingSafety').textContent = safety.toFixed(1) + '/5';
        document.getElementById('ratingOverall').textContent = overall.toFixed(1) + '/5';


        document.getElementById('progressCoaching').style.width = (coaching / 5 * 100) + '%';
        document.getElementById('progressDevelopment').style.width = (development / 5 * 100) + '%';
        document.getElementById('progressTransparency').style.width = (transparency / 5 * 100) + '%';
        document.getElementById('progressCulture').style.width = (culture / 5 * 100) + '%';
        document.getElementById('progressSafety').style.width = (safety / 5 * 100) + '%';


        if (r.flags && r.flags.length > 0) {
            document.getElementById('flagsSection').style.display = 'block';
            const flagsContainer = document.getElementById('flagsContainer').querySelector('.card-body');
            flagsContainer.innerHTML = '';

            r.flags.forEach(flag => {
                const flagDate = new Date(flag.createdAt).toLocaleDateString();
                const reporterEmail = flag.reporter.email || "ANONYMOUS";
                const flagStatusClass = flag.status === 'RESOLVED' ? 'text-success' :
                    flag.status === 'REJECTED' ? 'text-danger' : 'text-warning';

                const flagElement = document.createElement('div');
                flagElement.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border-bottom flag-item';
                flagElement.setAttribute('data-flag-id', flag.id);
                flagElement.setAttribute('data-bs-toggle', 'tooltip');
                flagElement.setAttribute('title', `Reported by: ${reporterEmail}`);

                flagElement.innerHTML = `
                    <div class="flag-reason" data-flag-id="${flag.id}">
                        <strong>${flag.reason}</strong> 
                        <span class="badge ${flagStatusClass}">${flag.status}</span>
                    </div>
                    <div class="text-muted small">${flagDate}</div>
                `;
                flagsContainer.appendChild(flagElement);
            });


            if (typeof $ !== 'undefined' && $.fn.tooltip) {
                $('[data-toggle="tooltip"]').tooltip();
            }
        } else {
            document.getElementById('flagsSection').style.display = 'none';
        }


        document.getElementById('ratingStars').innerHTML = getStarRating(overall);


        if (window.currentResponse) {
            document.getElementById('adminResponseText').textContent = window.currentResponse.body;
            document.getElementById('adminResponseDate').textContent = 'Posted: ' + new Date(window.currentResponse.createdAt).toLocaleString();
            document.getElementById('adminResponseBy').textContent = 'By: ' + (window.currentResponse.user?.email || 'Admin');
            document.getElementById('adminResponseSection').style.display = 'block';


            document.getElementById('replyText').value = window.currentResponse.body;
            document.getElementById('submitReplyBtn').style.display = 'none';
            document.getElementById('updateReplyBtn').style.display = 'inline-block';
        } else {
            document.getElementById('adminResponseSection').style.display = 'none';
            document.getElementById('replyText').value = '';
            document.getElementById('submitReplyBtn').style.display = 'inline-block';
            document.getElementById('updateReplyBtn').style.display = 'none';
        }


        if (typeof $ !== 'undefined' && $.fn.modal) {
            $('#reviewModal').modal('show');
        } else {

            const modal = document.getElementById('reviewModal');
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }
    }



    document.getElementById('submitReplyBtn').addEventListener('click', async function () {
        const responseText = document.getElementById('replyText').value.trim();

        if (!responseText) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please enter a response'
            });
            return;
        }

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/${window.currentReviewId}/respond`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getCookie('accessToken')}`
                },
                body: JSON.stringify({
                    body: responseText
                })
            });

            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${res.status}: Failed to submit response`);
            }

            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Response submitted successfully'
            });


            fetchReviews();


            if (typeof $ !== 'undefined' && $.fn.modal) {
                $('#reviewModal').modal('hide');
            }
        } catch (err) {
            console.error('Error submitting response:', err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Failed: ${err.message}`
            });
        }
    });


    document.getElementById('updateReplyBtn').addEventListener('click', async function () {
        const responseText = document.getElementById('replyText').value.trim();

        if (!responseText) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please enter a response'
            });
            return;
        }

        try {
            const res = await fetch(`${window.APP_CONFIG.API_URL}/teams/${window.currentReviewId}/respond`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getCookie('accessToken')}`
                },
                body: JSON.stringify({
                    body: responseText
                })
            });

            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${res.status}: Failed to update response`);
            }

            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Response updated successfully'
            });


            fetchReviews();


            if (typeof $ !== 'undefined' && $.fn.modal) {
                $('#reviewModal').modal('hide');
            }
        } catch (err) {
            console.error('Error updating response:', err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Failed: ${err.message}`
            });
        }
    });


    document.getElementById('reviewModal').addEventListener('click', async function (e) {
        if (e.target.classList.contains('flag-reason') || e.target.closest('.flag-reason')) {
            const flagElement = e.target.closest('.flag-reason');
            const flagId = flagElement.dataset.flagId;

            const { value: selectedStatus } = await Swal.fire({
                title: 'Update Flag Status',
                input: 'select',
                inputOptions: {
                    INVESTIGATING: 'Investigating',
                    REJECTED: 'Rejected',
                    RESOLVED: 'Resolved'
                },
                inputPlaceholder: 'Select status',
                showCancelButton: true,
                confirmButtonText: 'Update',
                cancelButtonText: 'Cancel'
            });

            if (!selectedStatus) {
                return;
            }

            try {
                const res = await fetch(`${window.APP_CONFIG.API_URL}/admin/flag/${flagId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getCookie('accessToken')}`
                    },
                    body: JSON.stringify({
                        status: selectedStatus
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP ${res.status}: Failed to update flag`);
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Flag status updated successfully'
                });


                fetchReviews();
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: err.message
                });
            }
        }
    });

    // Tambahkan fungsi exportCSV
    async function exportCSV() {
        // Ambil sort yang sedang aktif — kita simpan di window.currentSort
        const sort = window.currentSort || 'recent'; // default ke 'recent'

        try {
            let url = `${window.APP_CONFIG.API_URL}/teams/export/reviews/csv?sort=${sort}`;

            // Trigger download langsung
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `reviews-export-${sort}-${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            Swal.fire({
                icon: 'success',
                title: 'Export Started',
                text: 'Your CSV file is being downloaded.',
                timer: 2000,
                showConfirmButton: false
            });
        } catch (err) {
            console.error("Error exporting CSV:", err);
            Swal.fire({
                icon: 'error',
                title: 'Export Failed',
                text: 'Failed to export reviews: ' + err.message
            });
        }
    }

    // Pasang event listener ke tombol
    document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);


    document.getElementById('reviewGlobalSearch').addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();
        window.filteredReviews = window.allReviews.filter(r => {
            return (
                (r.team?.name && r.team.name.toLowerCase().includes(searchTerm)) ||
                (r.user?.email && r.user.email.toLowerCase().includes(searchTerm)) ||
                (r.title && r.title.toLowerCase().includes(searchTerm)) ||
                (r.body && r.body.toLowerCase().includes(searchTerm)) ||
                (r.age_level_at_review && r.age_level_at_review.toLowerCase().includes(searchTerm)) ||
                (r.season_term && r.season_term.toLowerCase().includes(searchTerm))
            );
        });
        window.currentPage = 1;
        renderTable();
        renderPaginationControls();
    });


    fetchReviews("recent");

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
</script>